<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>WhatsApp Beaut√© - Collecte GPS & Liens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #ff4d6d;
            --primary-dark: #c9184a;
            --primary-light: #ffe5e9;
            --secondary: #25D366;
            --secondary-dark: #075e54;
            --bg: #fff5f7;
            --card-bg: #ffffff;
            --text: #2d1b2b;
            --text-light: #6b4e6a;
            --border: #ffd9e0;
            --shadow: 0 4px 20px rgba(255, 77, 109, 0.15);
            --radius: 16px;
            --radius-sm: 10px;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: clamp(12px, 4vw, 20px);
            border-radius: var(--radius) var(--radius) 0 0;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }

        .header p {
            font-size: clamp(0.75rem, 3vw, 0.9rem);
            opacity: 0.95;
        }

        .main-panel {
            background: var(--card-bg);
            border-radius: 0 0 var(--radius) var(--radius);
            padding: clamp(12px, 4vw, 24px);
            box-shadow: var(--shadow);
        }

        .phone-section {
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            padding: clamp(10px, 3vw, 16px);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border);
        }

        .phone-section label {
            font-weight: 600;
            color: var(--primary);
            font-size: clamp(0.8rem, 3vw, 0.95rem);
            white-space: nowrap;
        }

        .phone-input-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .phone-input-group input {
            flex: 1;
            min-width: 150px;
            padding: clamp(6px, 2vw, 10px) clamp(8px, 3vw, 14px);
            border: 1px solid var(--border);
            border-radius: 30px;
            font-size: clamp(0.8rem, 3vw, 0.95rem);
            background: white;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 350px), 1fr));
            gap: clamp(12px, 3vw, 20px);
            margin-bottom: 20px;
        }

        .card {
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            padding: clamp(12px, 3vw, 20px);
            border: 1px solid var(--border);
        }

        .card h3 {
            font-size: clamp(0.95rem, 4vw, 1.2rem);
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            height: clamp(150px, 40vh, 250px);
            padding: clamp(10px, 3vw, 16px);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: clamp(0.85rem, 3vw, 0.95rem);
            line-height: 1.5;
            resize: vertical;
            background: white;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 77, 109, 0.2);
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 12px 0 8px;
        }

        .btn {
            padding: clamp(4px, 2vw, 8px) clamp(8px, 3vw, 16px);
            border-radius: 30px;
            font-weight: 500;
            font-size: clamp(0.7rem, 2.5vw, 0.85rem);
            border: 1px solid var(--border);
            background: white;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            line-height: 1.2;
        }

        .btn-sm {
            padding: clamp(2px, 1.5vw, 6px) clamp(6px, 2vw, 12px);
            font-size: clamp(0.65rem, 2vw, 0.8rem);
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary-dark);
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            border-color: var(--secondary-dark);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
            border-color: #138496;
        }

        .btn-warning {
            background: var(--warning);
            border-color: #e0a800;
            color: #333;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: #b02a37;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .produits-panel {
            background: white;
            border-radius: var(--radius-sm);
            padding: clamp(10px, 3vw, 16px);
            margin: 12px 0;
            border: 2px solid var(--primary-light);
        }

        .produits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .produits-header h4 {
            color: var(--primary);
            font-size: clamp(0.9rem, 3.5vw, 1rem);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .produits-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 16px 0;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .produit-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: clamp(8px, 2vw, 12px);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: white;
        }

        .produit-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .produit-checkbox {
            width: 18px;
            height: 18px;
            min-width: 18px;
            cursor: pointer;
            accent-color: var(--primary);
            margin-top: 3px;
        }

        .produit-content {
            flex: 1;
            min-width: 0;
        }

        .produit-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .produit-name {
            font-weight: 600;
            font-size: clamp(0.8rem, 3vw, 0.9rem);
            word-break: break-word;
        }

        .produit-prix {
            font-size: 0.8rem;
            color: var(--primary);
            background: var(--primary-light);
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .produit-link-input {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .produit-link-input input {
            flex: 1;
            min-width: 150px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .produit-link-display {
            font-size: 0.7rem;
            color: var(--info);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            background: #f0f8ff;
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 6px;
        }

        .add-produit-section {
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            padding: clamp(12px, 3vw, 16px);
            margin-top: 16px;
            border: 1px dashed var(--primary);
        }

        .add-produit-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(150px, 100%), 1fr));
            gap: 8px;
        }

        .add-produit-form input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 30px;
            font-size: 0.85rem;
        }

        .whatsapp-preview {
            background: #ece5dd;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin: 16px 0;
            position: relative;
        }

        .message-preview {
            background: white;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .filter-section {
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            padding: clamp(12px, 3vw, 16px);
            margin: 20px 0;
            border: 1px solid var(--border);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(140px, 100%), 1fr));
            gap: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            background: white;
        }

        .stats-bar {
            background: var(--primary);
            color: white;
            border-radius: var(--radius-sm);
            padding: clamp(10px, 3vw, 16px);
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(120px, 100%), 1fr));
            gap: 12px;
        }

        .stats-item {
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
        }

        .stats-item span {
            font-weight: 700;
            font-size: clamp(1rem, 4vw, 1.3rem);
            display: block;
            line-height: 1.2;
            word-break: break-word;
        }

        .table-container {
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: white;
            overflow-x: auto;
            margin: 16px 0;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
            font-size: 0.8rem;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 10px 6px;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            word-break: break-word;
        }

        .action-cell {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 500;
            display: inline-block;
            white-space: nowrap;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #e1f5fe;
            color: #01579b;
        }

        .link-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-cell a {
            color: var(--info);
            text-decoration: none;
        }

        .link-cell a:hover {
            text-decoration: underline;
        }

        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            align-items: center;
        }

        .message-counter {
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            left: 16px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(255, 77, 109, 0.3);
            transform: translateX(calc(100% + 16px));
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            margin-left: auto;
            pointer-events: none;
            word-break: break-word;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
            color: #333;
        }

        .text-small {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .mt-2 {
            margin-top: 8px;
        }

        .flex {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .link-icon {
            width: 14px;
            height: 14px;
            display: inline-block;
            background: var(--primary);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'/%3E%3C/svg%3E") no-repeat center;
            mask-size: contain;
        }

        .text-center {
            text-align: center;
        }

        .w-100 {
            width: 100%;
        }

        .gps-coord {
            font-family: monospace;
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
        }

        @media (max-width: 480px) {
            .btn-group {
                justify-content: stretch;
            }
            
            .btn {
                flex: 1 1 auto;
                justify-content: center;
            }
            
            .add-produit-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>
            <span>üíÑ</span> 
            WhatsApp Beaut√© - GPS & Liens
        </h1>
        <p>Extraction automatique ¬∑ Coordonn√©es GPS ¬∑ Liens Google Maps ¬∑ Liens produits</p>
    </div>

    <div class="main-panel">
        <div class="phone-section">
            <label>üì± Votre num√©ro:</label>
            <div class="phone-input-group">
                <input type="text" id="senderNumber" placeholder="+22890123456" value="+228">
                <button class="btn btn-primary" id="saveSenderBtn">OK</button>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>üìã 1. Coller les commandes</h3>
                <textarea id="inputText" placeholder="üíÑ *COMMANDE BEAUT√â PRO* üíÑ

üë§ *Informations client:*
üìõ Nom: Kola
üì± WhatsApp: 93387595
üè† Adresse: Kara, Pr√©fecture de Kozah, R√©gion de la Kara, Togo
üìç Coordonn√©es GPS: 9.550996, 1.194176
üó∫Ô∏è Lien Google Maps: https://www.google.com/maps?q=9.5509958,1.1941764

üõçÔ∏è *Articles command√©s:*
‚Ä¢ Foundation Haute Couvrance (1 x 18‚ÄØ500 FCFA) https://beauty.com/foundation
‚Ä¢ Highlighter Lumi√®re Dor√©e (1 x 14‚ÄØ500 FCFA) https://beauty.com/highlighter

üí∞ *Total:* 35‚ÄØ000 FCFA
üí≥ *Paiement:* PayPal"></textarea>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="extractAndSaveBtn">üîç Extraire</button>
                    <button class="btn" id="sampleDataBtn">üìù Exemple</button>
                    <button class="btn" id="clearInputBtn">üóëÔ∏è Effacer</button>
                </div>
                
                <div id="duplicateWarning" class="duplicate-warning" style="display:none; background:#fff3cd; color:#856404; padding:8px; border-radius:8px; margin:10px 0; font-size:0.85rem;">
                    ‚ö†Ô∏è Des commandes en double ont √©t√© ignor√©es
                </div>
            </div>

            <div class="card">
                <h3>‚úâÔ∏è 2. Message avec liens</h3>
                
                <div class="produits-panel">
                    <div class="produits-header">
                        <h4>
                            <span>üíÑ Produits avec liens</span>
                            <span class="badge-info" id="produitCount" style="background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:20px;">0</span>
                        </h4>
                        <div class="flex">
                            <button class="btn btn-sm btn-info" id="resetProduitsBtn">‚Ü∫ Par d√©faut</button>
                            <button class="btn btn-sm btn-danger" id="clearAllProduitsBtn">üóëÔ∏è Tout</button>
                        </div>
                    </div>
                    
                    <div class="produits-grid" id="produitsList">
                        <!-- Produits g√©n√©r√©s dynamiquement -->
                    </div>
                    
                    <div class="add-produit-section">
                        <div class="add-produit-title" style="font-weight:600; color:var(--primary); margin-bottom:10px;">‚ûï Nouveau produit</div>
                        <div class="add-produit-form">
                            <input type="text" id="newProduitName" placeholder="Nom du produit">
                            <input type="text" id="newProduitPrix" placeholder="Prix FCFA">
                            <input type="url" id="newProduitLink" placeholder="Lien (optionnel)">
                            <button class="btn btn-success" id="addProduitBtn">Ajouter</button>
                        </div>
                    </div>
                </div>

                <div class="whatsapp-preview">
                    <div class="message-preview" id="messagePreview">
                        Chargement...
                    </div>
                </div>

                <div class="flex">
                    <button class="btn btn-warning btn-sm" id="testMessageBtn">üëÅÔ∏è Actualiser</button>
                    <button class="btn btn-success btn-sm" id="sendAllBtn">üì§ Envoyer √† tous</button>
                    <button class="btn btn-sm" id="openWhatsAppWebBtn">üåê WhatsApp Web</button>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>üîç Recherche</label>
                    <input type="text" id="filterText" placeholder="Nom, t√©l√©phone...">
                </div>
                <div class="filter-group">
                    <label>Ville</label>
                    <select id="filterVille">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Statut</label>
                    <select id="filterStatus">
                        <option value="">Tous</option>
                        <option value="sent">Confirm√©</option>
                        <option value="pending">En attente</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Avec GPS</label>
                    <select id="filterGPS">
                        <option value="">Tous</option>
                        <option value="yes">Avec GPS</option>
                        <option value="no">Sans GPS</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">Filtrer</button>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stats-item"><span id="totalCount">0</span> commandes</div>
            <div class="stats-item"><span id="uniqueVilles">0</span> villes</div>
            <div class="stats-item"><span id="sentCount">0</span> confirm√©es</div>
            <div class="stats-item"><span id="gpsCount">0</span> avec GPS</div>
            <div class="stats-item"><span id="totalMontant">0</span> FCFA</div>
        </div>

        <h3 style="font-size:1rem; margin-bottom:10px;">üìã Commandes avec GPS et liens</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>S√©l.</th>
                        <th>Client</th>
                        <th>T√©l√©phone</th>
                        <th>Ville</th>
                        <th>GPS</th>
                        <th>Google Maps</th>
                        <th>Articles</th>
                        <th>Total</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="10" class="text-center" style="padding:40px;">Aucune commande</td></tr>
                </tbody>
            </table>
        </div>

        <div class="action-bar">
            <button class="btn btn-sm" id="exportFilteredBtn">üì• Export CSV</button>
            <button class="btn btn-sm btn-danger" id="deleteAllBtn">üóëÔ∏è Tout supprimer</button>
            <button class="btn btn-sm btn-warning" id="resetStatusBtn">üîÑ R√©init. statuts</button>
            <button class="btn btn-sm" id="checkDuplicatesBtn">üîç V√©rifier doublons</button>
            <button class="btn btn-sm btn-info" id="exportGPSBtn">üìç Exporter GPS</button>
            <button class="btn btn-sm btn-primary" id="sendSelectedBtn" disabled>üì§ Envoyer s√©lection</button>
            <span id="selectedCount" class="message-counter">0</span>
        </div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
    (function() {
        const DB_NAME = 'BeautyGPSDB';
        const DB_VERSION = 11;
        const STORE_NAME = 'commandes';
        const PRODUITS_STORE = 'produits';
        
        let db = null;
        let produits = [];
        let selectedIds = new Set();

        const DEFAULT_PRODUITS = [
            { name: 'Foundation Haute Couvrance', prix: '18500', link: 'https://beauty.com/foundation', selected: true },
            { name: 'Highlighter Lumi√®re Dor√©e', prix: '14500', link: 'https://beauty.com/highlighter', selected: true },
            { name: 'Rouge √† L√®vres Mat', prix: '12500', link: 'https://beauty.com/lipstick', selected: true },
            { name: 'Mascara Volume Extra', prix: '9800', link: 'https://beauty.com/mascara', selected: true },
            { name: 'Palette Ombres √† Paupi√®res', prix: '22500', link: 'https://beauty.com/palette', selected: true }
        ];

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject('Erreur DB');
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('telephone', 'telephone', { unique: false });
                        store.createIndex('date_commande', 'date_commande', { unique: false });
                        store.createIndex('telephone_date', ['telephone', 'date_commande'], { unique: true });
                        store.createIndex('has_gps', 'has_gps', { unique: false });
                        store.createIndex('ville', 'ville', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(PRODUITS_STORE)) {
                        const produitStore = db.createObjectStore(PRODUITS_STORE, { keyPath: 'id', autoIncrement: true });
                        produitStore.createIndex('name', 'name', { unique: true });
                        DEFAULT_PRODUITS.forEach(p => produitStore.add({...p}));
                    }
                };
            });
        }

        async function loadProduits() {
            if (!db) return DEFAULT_PRODUITS;
            
            return new Promise((resolve) => {
                const transaction = db.transaction([PRODUITS_STORE], 'readonly');
                const store = transaction.objectStore(PRODUITS_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const loaded = request.result || [];
                    if (loaded.length === 0) {
                        addDefaultProduits();
                        resolve(DEFAULT_PRODUITS);
                    } else {
                        resolve(loaded);
                    }
                };
                
                request.onerror = () => resolve(DEFAULT_PRODUITS);
            });
        }

        function addDefaultProduits() {
            const transaction = db.transaction([PRODUITS_STORE], 'readwrite');
            const store = transaction.objectStore(PRODUITS_STORE);
            DEFAULT_PRODUITS.forEach(p => store.add({...p}));
        }

        async function addProduit(name, prix, link) {
            const transaction = db.transaction([PRODUITS_STORE], 'readwrite');
            const store = transaction.objectStore(PRODUITS_STORE);
            
            const produit = {
                name: name.trim(),
                prix: prix.trim() || '0',
                link: link.trim() || '',
                selected: true
            };
            
            return new Promise((resolve, reject) => {
                const request = store.add(produit);
                request.onsuccess = () => resolve(produit);
                request.onerror = () => reject('Ce produit existe d√©j√†');
            });
        }

        async function updateProduit(id, updates) {
            const transaction = db.transaction([PRODUITS_STORE], 'readwrite');
            const store = transaction.objectStore(PRODUITS_STORE);
            const data = await store.get(id);
            Object.assign(data, updates);
            await store.put(data);
        }

        async function deleteProduit(id) {
            const transaction = db.transaction([PRODUITS_STORE], 'readwrite');
            await transaction.objectStore(PRODUITS_STORE).delete(id);
        }

        async function deleteAllProduits() {
            const transaction = db.transaction([PRODUITS_STORE], 'readwrite');
            await transaction.objectStore(PRODUITS_STORE).clear();
        }

        function extraireCommandeFromText(text) {
            const commandes = [];
            
            // Informations client
            const nomMatch = text.match(/üìõ Nom:\s*(.+?)(?:\n|$)/i);
            const telMatch = text.match(/üì± WhatsApp:\s*(.+?)(?:\n|$)/i);
            const adresseMatch = text.match(/üè† Adresse:\s*(.+?)(?:\n|$)/i);
            
            // GPS et liens
            const gpsMatch = text.match(/üìç Coordonn√©es GPS:\s*([\d.,\s-]+)(?:\n|$)/i);
            const mapsMatch = text.match(/üó∫Ô∏è Lien Google Maps:\s*(https?:\/\/[^\s]+)(?:\n|$)/i);
            
            // Extraire ville depuis l'adresse
            let ville = '';
            if (adresseMatch) {
                const parties = adresseMatch[1].split(',');
                ville = parties[0].trim();
            }
            
            // Extraction articles avec leurs liens
            const articles = [];
            const articleRegex = /‚Ä¢\s*(.+?)\s*\((\d+)\s*x\s*([\d\s]+)\s*FCFA\)(?:\s*(https?:\/\/[^\s]+))?/g;
            let match;
            while ((match = articleRegex.exec(text)) !== null) {
                articles.push({
                    nom: match[1].trim(),
                    quantite: parseInt(match[2]),
                    prix: parseInt(match[3].replace(/\s/g, '')),
                    lien: match[4] || '' // Lien optionnel de l'article
                });
            }
            
            const totalMatch = text.match(/üí∞ \*Total:\*\s*([\d\s]+)\s*FCFA/);
            const paiementMatch = text.match(/üí≥ \*Paiement:\*\s*(.+?)(?:\n|$)/i);
            const dateMatch = text.match(/‚è∞ \*Date:\*\s*(.+?)(?:\n|$)/);

            if (nomMatch || telMatch) {
                let telephone = telMatch ? telMatch[1].trim().replace(/\s/g, '') : '';
                if (telephone && !telephone.startsWith('+')) {
                    telephone = '+228' + telephone;
                }

                // Traitement des coordonn√©es GPS
                let gps = null;
                let has_gps = false;
                if (gpsMatch) {
                    const coords = gpsMatch[1].split(',').map(c => parseFloat(c.trim()));
                    if (coords.length >= 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        gps = {
                            lat: coords[0],
                            lng: coords[1]
                        };
                        has_gps = true;
                    }
                }

                commandes.push({
                    nom: nomMatch ? nomMatch[1].trim() : 'Inconnu',
                    telephone: telephone,
                    adresse: adresseMatch ? adresseMatch[1].trim() : '',
                    ville: ville,
                    gps: gps,
                    has_gps: has_gps,
                    maps_link: mapsMatch ? mapsMatch[1].trim() : '',
                    articles: articles,
                    total: totalMatch ? parseInt(totalMatch[1].replace(/\s/g, '')) : 0,
                    paiement: paiementMatch ? paiementMatch[1].trim() : 'Non sp√©cifi√©',
                    date_commande: dateMatch ? dateMatch[1].trim() : new Date().toLocaleString('fr-FR'),
                    date_extraction: new Date().toISOString(),
                    whatsapp_sent: false,
                    whatsapp_date: null
                });
            }
            
            return commandes;
        }

        async function checkDuplicate(commande) {
            if (!db || !commande.telephone || !commande.date_commande) return false;
            
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('telephone_date');
                const request = index.getAll([commande.telephone, commande.date_commande]);
                
                request.onsuccess = () => resolve(request.result.length > 0);
                request.onerror = () => resolve(false);
            });
        }

        async function addCommande(commande) {
            if (!db) return { added: false, reason: 'DB non initialis√©e' };
            
            const isDuplicate = await checkDuplicate(commande);
            if (isDuplicate) return { added: false, reason: 'doublon' };
            
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(commande);
                
                request.onsuccess = () => resolve({ added: true, id: request.result });
                request.onerror = () => resolve({ added: false, reason: 'erreur' });
            });
        }

        function getAllCommandes() {
            return new Promise((resolve) => {
                if (!db) return resolve([]);
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => resolve([]);
            });
        }

        function updateCommande(id, updates) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const getRequest = store.get(id);
                
                getRequest.onsuccess = () => {
                    const data = getRequest.result;
                    Object.assign(data, updates);
                    store.put(data).onsuccess = () => resolve(data);
                };
            });
        }

        function deleteCommande(id) {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                transaction.objectStore(STORE_NAME).delete(id).onsuccess = () => resolve();
            });
        }

        function deleteAllCommandes() {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                transaction.objectStore(STORE_NAME).clear().onsuccess = () => resolve();
            });
        }

        function generateConfirmationMessage(commande) {
            const prenom = commande.nom.split(' ')[0] || 'cher client';
            
            // Liste des produits recommand√©s avec leurs liens
            const produitsRecommandes = produits
                .filter(p => p.selected)
                .map(p => {
                    if (p.link) {
                        return `‚Ä¢ ${p.name} (${p.prix} FCFA) : ${p.link}`;
                    }
                    return `‚Ä¢ ${p.name} (${p.prix} FCFA)`;
                })
                .join('\n');
            
            // Ajouter le lien Google Maps si disponible
            const mapsInfo = commande.maps_link ? `\nüó∫Ô∏è Localisation: ${commande.maps_link}` : '';
            
            return `Bonjour ${prenom}, merci pour votre commande ! üíï

R√©capitulatif :
${commande.articles.map(a => {
    let article = `‚Ä¢ ${a.nom} (${a.quantite}x ${a.prix} FCFA)`;
    if (a.lien) article += `\n  Lien: ${a.lien}`;
    return article;
}).join('\n')}

üí∞ Total: ${commande.total.toLocaleString('fr-FR')} FCFA
üí≥ Paiement: ${commande.paiement}
üìç Livraison: ${commande.ville}${mapsInfo}

D√©couvrez aussi nos autres produits :
${produitsRecommandes || '‚Ä¢ Consultez notre catalogue en ligne'}

Nous vous tiendrons inform√© d√®s l'exp√©dition.

√Ä bient√¥t ! ‚ú®
L'√©quipe Beaut√© Pro`;
        }

        async function sendWhatsAppMessage(commande) {
            if (!commande.telephone) throw new Error('T√©l√©phone manquant');
            
            const message = generateConfirmationMessage(commande);
            const phoneNumber = commande.telephone.replace(/\s+/g, '');
            window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
            
            if (!commande.whatsapp_sent) {
                await updateCommande(commande.id, {
                    whatsapp_sent: true,
                    whatsapp_date: new Date().toISOString()
                });
            }
        }

        async function sendToMultiple(commandes) {
            for (let cmd of commandes) {
                try {
                    await sendWhatsAppMessage(cmd);
                    await new Promise(r => setTimeout(r, 1500));
                } catch (e) {
                    console.error('Erreur envoi:', e);
                }
            }
        }

        window.sendSingleMessage = async (id) => {
            const allData = await getAllCommandes();
            const commande = allData.find(e => e.id === id);
            if (commande) {
                try {
                    await sendWhatsAppMessage(commande);
                    showNotification(`Message envoy√© √† ${commande.nom}`);
                    await refreshTable();
                } catch (e) {
                    showNotification('Erreur d\'envoi', 'error');
                }
            }
        };

        window.deleteSingleEntry = async (id) => {
            if (confirm('Supprimer cette commande ?')) {
                await deleteCommande(id);
                selectedIds.delete(id);
                await refreshTable();
                showNotification('Commande supprim√©e');
            }
        };

        window.toggleSelection = (id) => {
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            updateSelectedCount();
        };

        window.openMaps = (lat, lng) => {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        };

        let currentFilteredData = [];

        async function refreshTable() {
            const allData = await getAllCommandes();
            
            const filterText = document.getElementById('filterText').value.toLowerCase();
            const filterVille = document.getElementById('filterVille').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterGPS = document.getElementById('filterGPS').value;

            let filtered = allData.filter(item => {
                if (filterText && !(item.nom?.toLowerCase().includes(filterText) || 
                                   item.telephone?.includes(filterText))) return false;
                if (filterVille && item.ville !== filterVille) return false;
                if (filterStatus === 'sent' && !item.whatsapp_sent) return false;
                if (filterStatus === 'pending' && item.whatsapp_sent) return false;
                if (filterGPS === 'yes' && !item.has_gps) return false;
                if (filterGPS === 'no' && item.has_gps) return false;
                return true;
            });

            currentFilteredData = filtered;

            const totalMontant = allData.reduce((acc, cmd) => acc + (cmd.total || 0), 0);
            const gpsCount = allData.filter(cmd => cmd.has_gps).length;
            
            document.getElementById('totalCount').textContent = allData.length;
            document.getElementById('sentCount').textContent = allData.filter(e => e.whatsapp_sent).length;
            document.getElementById('gpsCount').textContent = gpsCount;
            document.getElementById('totalMontant').textContent = totalMontant.toLocaleString('fr-FR');
            
            const villes = [...new Set(allData.map(i => i.ville).filter(v => v))];
            document.getElementById('uniqueVilles').textContent = villes.length;

            const selectVille = document.getElementById('filterVille');
            selectVille.innerHTML = '<option value="">Toutes</option>';
            villes.sort().forEach(v => {
                selectVille.innerHTML += `<option value="${v}">${v}</option>`;
            });

            const tbody = document.getElementById('tableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding:40px;">Aucune commande</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const statutClass = item.whatsapp_sent ? 'badge-success' : 'badge-warning';
                const statutText = item.whatsapp_sent ? '‚úÖ Confirm√©' : '‚è≥ En attente';
                
                const gpsDisplay = item.has_gps ? 
                    `<span class="gps-coord" onclick="openMaps(${item.gps.lat}, ${item.gps.lng})" style="cursor:pointer;">üìç ${item.gps.lat.toFixed(4)}, ${item.gps.lng.toFixed(4)}</span>` : 
                    '‚Äî';
                
                const mapsDisplay = item.maps_link ? 
                    `<a href="${item.maps_link}" target="_blank" class="link-cell">üó∫Ô∏è Voir</a>` : 
                    '‚Äî';
                
                return `<tr>
                    <td><input type="checkbox" onchange="toggleSelection(${item.id})" ${selectedIds.has(item.id) ? 'checked' : ''}></td>
                    <td>${escapeHtml(item.nom || '')}</td>
                    <td>${escapeHtml(item.telephone || '')}</td>
                    <td>${escapeHtml(item.ville || '')}</td>
                    <td>${gpsDisplay}</td>
                    <td>${mapsDisplay}</td>
                    <td>${item.articles?.length || 0} art.</td>
                    <td>${(item.total || 0).toLocaleString('fr-FR')}</td>
                    <td><span class="badge ${statutClass}">${statutText}</span></td>
                    <td class="action-cell">
                        <button class="btn btn-sm" onclick="sendSingleMessage(${item.id})" title="Envoyer">üì§</button>
                        <button class="btn btn-sm" onclick="deleteSingleEntry(${item.id})" title="Supprimer">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedIds.size;
            document.getElementById('selectedCount').textContent = `${count} s√©lectionn√©e(s)`;
            document.getElementById('sendSelectedBtn').disabled = count === 0;
        }

        function showNotification(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = `notification ${type}`;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        async function renderProduits() {
            produits = await loadProduits();
            
            const container = document.getElementById('produitsList');
            container.innerHTML = '';
            
            produits.sort((a, b) => a.name.localeCompare(b.name));
            
            produits.forEach(p => {
                const div = document.createElement('div');
                div.className = `produit-item ${p.selected ? 'selected' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" class="produit-checkbox" ${p.selected ? 'checked' : ''} data-id="${p.id}">
                    <div class="produit-content">
                        <div class="produit-header">
                            <span class="produit-name">${escapeHtml(p.name)}</span>
                            <span class="produit-prix">${escapeHtml(p.prix)} FCFA</span>
                        </div>
                        <div class="produit-link-input">
                            <input type="url" class="produit-link" value="${escapeHtml(p.link || '')}" placeholder="Lien produit" data-id="${p.id}">
                            <button class="btn-sm btn-info" onclick="updateProduitLink(${p.id})">üíæ</button>
                            <button class="btn-sm btn-danger" onclick="deleteProduitItem(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
                
                const checkbox = div.querySelector('.produit-checkbox');
                checkbox.addEventListener('change', async (e) => {
                    p.selected = e.target.checked;
                    await updateProduit(p.id, { selected: p.selected });
                    div.classList.toggle('selected', p.selected);
                    updateMessagePreview();
                });
            });
            
            document.getElementById('produitCount').textContent = produits.length;
            updateMessagePreview();
        }

        window.updateProduitLink = async (id) => {
            const input = document.querySelector(`.produit-link[data-id="${id}"]`);
            if (input) {
                await updateProduit(id, { link: input.value });
                showNotification('Lien mis √† jour');
            }
        };

        window.deleteProduitItem = async (id) => {
            if (confirm('Supprimer ce produit ?')) {
                await deleteProduit(id);
                await renderProduits();
                showNotification('Produit supprim√©');
            }
        };

        function updateMessagePreview() {
            const demoCommande = {
                nom: 'Kola',
                articles: [
                    { nom: 'Foundation Haute Couvrance', quantite: 1, prix: 18500, lien: 'https://beauty.com/foundation' }
                ],
                total: 35000,
                paiement: 'PayPal',
                ville: 'Kara',
                maps_link: 'https://www.google.com/maps?q=9.5509958,1.1941764'
            };
            document.getElementById('messagePreview').textContent = generateConfirmationMessage(demoCommande);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                
                const saved = localStorage.getItem('senderNumber');
                if (saved) document.getElementById('senderNumber').value = saved;
                
                await renderProduits();
                await refreshTable();

                document.getElementById('saveSenderBtn').addEventListener('click', () => {
                    const num = document.getElementById('senderNumber').value.trim();
                    if (num) {
                        localStorage.setItem('senderNumber', num);
                        showNotification('Num√©ro enregistr√©');
                    }
                });

                document.getElementById('extractAndSaveBtn').addEventListener('click', async () => {
                    const text = document.getElementById('inputText').value;
                    if (!text.trim()) {
                        showNotification('Collez une commande', 'error');
                        return;
                    }
                    
                    const extracted = extraireCommandeFromText(text);
                    let added = 0, duplicates = 0;
                    
                    for (let cmd of extracted) {
                        const result = await addCommande(cmd);
                        if (result.added) added++;
                        else duplicates++;
                    }
                    
                    await refreshTable();
                    
                    if (duplicates > 0) {
                        document.getElementById('duplicateWarning').style.display = 'block';
                        showNotification(`${added} ajout√©e(s), ${duplicates} doublon(s)`, 'warning');
                        setTimeout(() => {
                            document.getElementById('duplicateWarning').style.display = 'none';
                        }, 5000);
                    } else {
                        showNotification(`${added} commande(s) ajout√©e(s)`);
                    }
                });

                document.getElementById('sampleDataBtn').addEventListener('click', () => {
                    document.getElementById('inputText').value = `üíÑ *COMMANDE BEAUT√â PRO* üíÑ

üë§ *Informations client:*
üìõ Nom: Kola
üì± WhatsApp: 93387595
üè† Adresse: Kara, Pr√©fecture de Kozah, R√©gion de la Kara, Togo
üìç Coordonn√©es GPS: 9.550996, 1.194176
üó∫Ô∏è Lien Google Maps: https://www.google.com/maps?q=9.5509958,1.1941764

üõçÔ∏è *Articles command√©s:*
‚Ä¢ Foundation Haute Couvrance (1 x 18‚ÄØ500 FCFA) https://beauty.com/foundation
‚Ä¢ Highlighter Lumi√®re Dor√©e (1 x 14‚ÄØ500 FCFA) https://beauty.com/highlighter

üí∞ *Total:* 35‚ÄØ000 FCFA
üí≥ *Paiement:* PayPal`;
                });

                document.getElementById('clearInputBtn').addEventListener('click', () => {
                    document.getElementById('inputText').value = '';
                });

                document.getElementById('applyFiltersBtn').addEventListener('click', refreshTable);
                document.getElementById('filterGPS').addEventListener('change', refreshTable);

                document.getElementById('addProduitBtn').addEventListener('click', async () => {
                    const name = document.getElementById('newProduitName').value.trim();
                    const prix = document.getElementById('newProduitPrix').value.trim();
                    const link = document.getElementById('newProduitLink').value.trim();
                    
                    if (!name || !prix) {
                        showNotification('Nom et prix requis', 'error');
                        return;
                    }
                    
                    try {
                        await addProduit(name, prix, link);
                        document.getElementById('newProduitName').value = '';
                        document.getElementById('newProduitPrix').value = '';
                        document.getElementById('newProduitLink').value = '';
                        await renderProduits();
                        showNotification(`Produit "${name}" ajout√©`);
                    } catch (e) {
                        showNotification('Ce produit existe d√©j√†', 'error');
                    }
                });

                document.getElementById('resetProduitsBtn').addEventListener('click', async () => {
                    if (confirm('R√©initialiser les produits par d√©faut ?')) {
                        await deleteAllProduits();
                        addDefaultProduits();
                        await renderProduits();
                        showNotification('Produits r√©initialis√©s');
                    }
                });

                document.getElementById('clearAllProduitsBtn').addEventListener('click', async () => {
                    if (confirm('Supprimer TOUS les produits ?')) {
                        await deleteAllProduits();
                        await renderProduits();
                        showNotification('Tous les produits supprim√©s');
                    }
                });

                document.getElementById('sendAllBtn').addEventListener('click', async () => {
                    const allData = await getAllCommandes();
                    const pending = allData.filter(e => !e.whatsapp_sent && e.telephone);
                    
                    if (pending.length === 0) {
                        showNotification('Aucune commande en attente', 'error');
                        return;
                    }
                    
                    await sendToMultiple(pending);
                    await refreshTable();
                    showNotification(`${pending.length} confirmation(s) envoy√©e(s)`);
                });

                document.getElementById('sendSelectedBtn').addEventListener('click', async () => {
                    if (selectedIds.size === 0) {
                        showNotification('Aucune s√©lection', 'error');
                        return;
                    }
                    
                    const allData = await getAllCommandes();
                    const selected = allData.filter(e => selectedIds.has(e.id) && e.telephone);
                    
                    if (selected.length === 0) {
                        showNotification('Aucune valide', 'error');
                        return;
                    }
                    
                    await sendToMultiple(selected);
                    
                    if (confirm('D√©s√©lectionner apr√®s envoi ?')) {
                        selectedIds.clear();
                    }
                    
                    await refreshTable();
                    showNotification(`${selected.length} confirmation(s) envoy√©e(s)`);
                });

                document.getElementById('testMessageBtn').addEventListener('click', updateMessagePreview);
                document.getElementById('openWhatsAppWebBtn').addEventListener('click', () => {
                    window.open('https://web.whatsapp.com', '_blank');
                });

                document.getElementById('exportFilteredBtn').addEventListener('click', () => {
                    if (currentFilteredData.length === 0) {
                        showNotification('Aucune donn√©e', 'error');
                        return;
                    }
                    
                    const headers = ['Client', 'T√©l√©phone', 'Ville', 'Latitude', 'Longitude', 'Maps Link', 'Total', 'Statut'];
                    const rows = currentFilteredData.map(c => [
                        c.nom,
                        c.telephone,
                        c.ville,
                        c.gps?.lat || '',
                        c.gps?.lng || '',
                        c.maps_link || '',
                        c.total,
                        c.whatsapp_sent ? 'Confirm√©' : 'En attente'
                    ]);
                    
                    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
                    
                    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'commandes.csv';
                    link.click();
                    URL.revokeObjectURL(link.href);
                });

                document.getElementById('exportGPSBtn').addEventListener('click', () => {
                    const allData = currentFilteredData;
                    const withGPS = allData.filter(c => c.has_gps);
                    
                    if (withGPS.length === 0) {
                        showNotification('Aucune coordonn√©e GPS', 'error');
                        return;
                    }
                    
                    const headers = ['Client', 'T√©l√©phone', 'Ville', 'Latitude', 'Longitude', 'Maps Link'];
                    const rows = withGPS.map(c => [
                        c.nom,
                        c.telephone,
                        c.ville,
                        c.gps.lat,
                        c.gps.lng,
                        c.maps_link || `https://www.google.com/maps?q=${c.gps.lat},${c.gps.lng}`
                    ]);
                    
                    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
                    
                    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'coordonnees_gps.csv';
                    link.click();
                    URL.revokeObjectURL(link.href);
                });

                document.getElementById('deleteAllBtn').addEventListener('click', async () => {
                    if (confirm('Supprimer TOUTES les commandes ?')) {
                        await deleteAllCommandes();
                        selectedIds.clear();
                        await refreshTable();
                        showNotification('Toutes les commandes supprim√©es');
                    }
                });

                document.getElementById('resetStatusBtn').addEventListener('click', async () => {
                    if (confirm('R√©initialiser tous les statuts ?')) {
                        const allData = await getAllCommandes();
                        for (let cmd of allData) {
                            await updateCommande(cmd.id, { whatsapp_sent: false, whatsapp_date: null });
                        }
                        await refreshTable();
                        showNotification('Statuts r√©initialis√©s');
                    }
                });

                document.getElementById('checkDuplicatesBtn').addEventListener('click', async () => {
                    const allData = await getAllCommandes();
                    const seen = new Set();
                    let duplicates = 0;
                    
                    allData.forEach(item => {
                        const key = `${item.telephone}|${item.date_commande}`;
                        if (seen.has(key)) duplicates++;
                        else seen.add(key);
                    });
                    
                    showNotification(duplicates ? `${duplicates} doublon(s) d√©tect√©(s)` : 'Aucun doublon', 
                                   duplicates ? 'warning' : 'success');
                });

            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur de chargement', 'error');
            }
        });
    })();
</script>
</body>
</html>